name: Flutter Version Increment

on:
  schedule:
    - cron: '07 12 * * 1' # Tous les lundis à 7h00 (heure française)

  issues:
    types:
      - labeled

jobs:
  create_pull_request:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest


    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create and checkout a new branch
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git checkout -b version-increment

      # Delete origin version-increment branch if it exists
      - name: Delete origin version-increment branch if it exists
        run: git push origin --delete version-increment

      - name: Create a temporary file with the current date
        run: echo "$(date)" > temp_date.txt

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update version type"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          title: "Version increment"
          branch: version-increment
          base: master
          labels: "Waiting for version type"
          reviewers: Ziedelth
          assignees: Ziedelth

  update_version_type:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'Waiting for version type') && (contains(github.event.label.name, 'major') || contains(github.event.label.name, 'minor') || contains(github.event.label.name, 'patch'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Run the bash script with the appropriate version type
        run: |
          chmod +x increment_version.sh
          if contains(github.event.label.name, 'major'); then
            ./increment_version.sh major
          elif contains(github.event.label.name, 'minor'); then
            ./increment_version.sh minor
          else
            ./increment_version.sh patch
          fi

      - name: Commit changes
        run: |
          git add pubspec.yaml
          git commit -m "Update version type"

      - name: Push changes
        run: git push origin HEAD

      - name: Add comment to the issue
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: "Version type updated and changes pushed to the pull request."
